# AIæŠ•è³‡ç­–ç•¥è¦åŠƒå¸« 
# CH-08 å»ºæ§‹æŠ•è³‡çµ„åˆï¼šè®“ AI è¼”åŠ©é¸è‚¡

## 8-1 å»ºæ§‹æŠ•è³‡çµ„åˆ


```python

### 1ï¸âƒ£ åŒ¯å…¥å¥—ä»¶ & æ›è¼‰é›²ç«¯ç¡¬ç¢Ÿ

!pip install gdown
import gdown
import os
import datetime as dt
import time
from IPython.display import display
import pandas as pd
from google.colab import drive
from tqdm import tqdm
drive.mount('/content/drive')

### 2ï¸âƒ£ ä¸‹è¼‰è³‡æ–™åº«
"""
è‹¥è³‡æ–™åº«æœªä¸‹è¼‰æˆåŠŸæˆ–å‡ºç¾ bugï¼Œè«‹æ‰‹å‹•é»æ“Šé€£çµä¸‹è¼‰ï¼Œä¸¦æ”¾å…¥ **æˆ‘çš„é›²ç«¯ç¡¬ç¢Ÿ>StockGPT** è³‡æ–™å¤¾ä¸­

ä¸‹è¼‰é€£çµï¼šhttps://drive.usercontent.google.com/download?id=1S5JE9ZF2hohRpvO8FikgLhQmN2DJrVgW
"""

# æŒ‡å®šä¸‹è¼‰è·¯å¾‘
!mkdir -p "/content/drive/MyDrive/StockGPT/"
output_path = '/content/drive/MyDrive/StockGPT/'

# æª¢æŸ¥è³‡æ–™åº«æ˜¯å¦å­˜åœ¨
stock_db_path = output_path + 'stock.db'
if not os.path.exists(stock_db_path):
    print("ä¸‹è¼‰è³‡æ–™åº«ä¸­...")
    id = '1S5JE9ZF2hohRpvO8FikgLhQmN2DJrVgW'

    gdown.download(id=id, output=stock_db_path)
    print("ä¸‹è¼‰å®Œæˆ")
else:
    print("ç„¡éœ€ä¸‹è¼‰")

### 3ï¸âƒ£ å®‰è£æ——æ¨™å¥—ä»¶

# Commented out IPython magic to ensure Python compatibility.
!git clone https://github.com/FlagTech/F3933.git
# %cd F3933
!pip install -r requirements.txt
from Ch06 import StockAnalysis, StockInfo
from Ch07 import PdfLoader
from Stock_DB import StockDB
# %cd ..


### 4ï¸âƒ£ æ›´æ–°è³‡æ–™åº«
"""
è³‡æ–™åº«æ›´æ–°éœ€è€—è²»è¼ƒé•·æ™‚é–“,
è‹¥ç„¡æ³•æ›´æ–°ï¼Œè«‹åˆªé™¤æˆ‘çš„é›²ç«¯ç¡¬ç¢Ÿ>StockGPT>stock.db æª”æ¡ˆï¼Œ
ä¸¦è‡³ç¬¬äºŒå€‹å„²å­˜æ ¼çš„é€£çµæ‰‹å‹•ä¸‹è¼‰
"""

stock_db = StockDB()
stock_db.renew()
stock_db.close()

###5ï¸âƒ£ æª¢è¦–è³‡æ–™è¡¨æ ¼å¼

# å¾è³‡æ–™åº«ä¸­å–å¾—è¡¨æ ¼
stock_db = StockDB()
df_company = stock_db.get("å…¬å¸")
df_daily = stock_db.get("æ—¥é »",psdate=True)
df_quarterly = stock_db.get("å­£é »",psdate=True)

# å»é™¤ç©ºå€¼
df_company = df_company.dropna()
df_daily = df_daily.dropna()
df_quarterly = df_quarterly.dropna()

# æª¢è¦–è³‡æ–™
display(df_company.head())
display(df_daily.head())
display(df_quarterly.head())

###6ï¸âƒ£ è¼¸å…¥ OpenAI API KEY & å»ºç«‹ç‰©ä»¶

import getpass
openai_api_key = getpass.getpass("è«‹è¼¸å…¥é‡‘é‘°ï¼š")
six = StockAnalysis(openai_api_key)
seven = PdfLoader(openai_api_key)

### 7ï¸âƒ£ AI è‡ªå‹•åŒ–é¸è‚¡æ©Ÿå™¨äºº
"""
<è¼¸å…¥ç¯„ä¾‹>
```
è«‹é¸å‡ºè¿‘ä¸€é€±æ¼²å¹…æœ€é«˜çš„10æª”è‚¡ç¥¨
è«‹é¸å‡ºå¤§å¸‚å€¼è‚¡(å‰10%)ä¸”è¿‘æœŸç‡Ÿæ”¶æˆé•·æœ€é«˜çš„10æª”è‚¡ç¥¨
è«‹é¸å‡ºåŠå°é«”æ¥­ä¸”è¿‘æœŸæ¯è‚¡ç›ˆé¤˜æˆé•·ç‡æœ€é«˜çš„10æª”è‚¡ç¥¨
è«‹é¸å‡ºè¿‘ä¸€å¹´è‚¡åƒ¹æ·¨å€¼æ¯”æœ€ä½çš„10æª”è‚¡ç¥¨
è«‹å¾è¿‘ä¸€å€‹æœˆæˆäº¤é‡å‰10%çš„è‚¡ç¥¨ä¸­æ‰¾å‡ºæ—¥æœ¬ç›Šæ¯”æœ€ä½çš„5æª”ä¸åŒçš„è‚¡ç¥¨
```
"""

# è¼¸å…¥ä½¿ç”¨è€…éœ€æ±‚
user_msg = input("è«‹è¼¸å…¥é¸è‚¡éœ€æ±‚:")

# è‡ªå‹•è™•ç† 3 å€‹è³‡æ–™è¡¨ä¸¦ç”Ÿæˆç¨‹å¼ç¢¼
history, code_str = six.ai_helper(user_msg)

# AI è‡ªå‹•é¸è‚¡ & é™¤éŒ¯
success = False
for _ in range(3):
    try:
        # æ–°å»º df è¡¨æ ¼
        df1 = df_company
        df2 = df_daily
        df3 = df_quarterly

        print(code_str)
        exec(code_str)
        new_df = calculate(df1, df2, df3)
        success = True
        break
    except Exception as e:
        print(f"AI é™¤éŒ¯ä¸­...")
        code_str = six.ai_debug(history, code_str, str(e))
        print(code_str)
        print("-------------------------")

if not success:
    print("è«‹æ›´æ›æˆ–é‡æ–°è¼¸å…¥é¸è‚¡éœ€æ±‚")
else:
    display(new_df)
```
## 8-2 AI è¶¨å‹¢å ±å‘Šæ¨è–¦ç³»çµ±
```python
### 8ï¸âƒ£ å–å¾—å€‹è‚¡åˆ†æå ±å‘Š


reply = six.stock_gpt(stock_id="2330")
print(reply)

### 9ï¸âƒ£ æ”¶é›†å¤šæª”è‚¡ç¥¨çš„è¶¨å‹¢å ±å‘Š
"""
10 æª”è‚¡ç¥¨ç´„æœƒè·‘ 5 åˆ†é˜, è‹¥è·‘å¤ªä¹…ç‚º API ç•¶æ‰
"""

# å»ºç«‹è‚¡ç¥¨æ¸…å–®
stock_list = ['2364', '2535', '3041', '5215', '2363',
              '1568', '2369', '2816', '9955', '2233']

# è¨­å®šå„²å­˜è·¯å¾‘
today_time = dt.date.today().strftime("%Y%m%d")
path = '/content/drive/MyDrive/StockGPT/TrendReport/'
os.makedirs(path, exist_ok=True)

# å»ºç«‹å¤šæª”è‚¡ç¥¨çš„è¶¨å‹¢å ±å‘Šä¸¦å„²å­˜
content = {}

for stock in stock_list:
  file_path = f"{path}trend_{stock}_{today_time}.txt"

  if os.path.exists(file_path):
    print(f"{stock} æª”æ¡ˆå·²å­˜åœ¨")
  else:
    with open(file_path, "w", encoding="utf-8") as f:
      f.write(six.stock_gpt(stock_id=stock))

  with open(file_path, "r", encoding="utf-8") as f:
      content[stock] = f.read()

### ğŸ”Ÿ æ¨è–¦å‡ºä¸€æª”è‚¡ç¥¨

def stock_choice(data):
    # è¨­å®šæç¤ºæ¨¡æ¿
    msg = [{
        "role": "system",
        "content":
        "ä½ ç¾åœ¨æ˜¯ä¸€ä½å°ˆæ¥­çš„è­‰åˆ¸åˆ†æå¸«, ä½ æœƒé‡å°å„è‚¡çš„å°ˆæ¥­è¶¨å‹¢åˆ†æå ±å‘Š, \n\
         é¸æ“‡å‡ºæœ€é©åˆæŠ•è³‡çš„ä¸€æª”è‚¡ç¥¨,ä¸¦èªªæ˜é¸æ“‡å®ƒçš„ç†ç”±ã€‚"
    }, {
        "role": "user",
        "content": str(data)
    }]

    reply_data = six.get_reply(msg)
    return reply_data

print(stock_choice(content))

### 1ï¸âƒ£1ï¸âƒ£ æ¨è–¦è‚¡ç¥¨çš„è©•åˆ†æ’åº

def stock_sort(data):
    # è¨­å®šæç¤ºæ¨¡æ¿
    msg = [{
        "role": "system",
        "content":
        "ä½ ç¾åœ¨æ˜¯ä¸€ä½å°ˆæ¥­çš„è‚¡ç¥¨åˆ†æå¸«, æœƒæ ¹æ“šå„è‚¡çš„å°ˆæ¥­è¶¨å‹¢åˆ†æå ±å‘Šå»è©•æ–·\
         é©ä¸é©åˆæŠ•è³‡, ä¸¦çµ¦äºˆ0-100ä¹‹é–“çš„è©•åˆ†ã€‚\n\
         ä»¥ 50 åˆ†ç‚ºåŸºæº–, æœ‰ä»»ä½•æ­£é¢æ¶ˆæ¯å¯ä»¥åŠ åˆ†å¦‚:\n\
         è‚¡åƒ¹æ•´é«”ä¸Šå‡ã€æ³•äººè²·è¶…ã€ç‡Ÿæ”¶æˆé•·ä¸Šå‡ã€æ–°èæœ‰æ­£é¢æ¶ˆæ¯ï¼›\n\
         è‹¥æœ‰ä»»ä½•è² é¢æ¶ˆæ¯å¿…é ˆæ‰£åˆ†å¦‚:\n\
         è‚¡åƒ¹æ•´é«”ä¸‹é™ã€æ³•äººè³£è¶…ã€ç‡Ÿæ”¶æˆé•·ä¸‹é™ã€æ–°èæœ‰è² é¢æ¶ˆæ¯ã€‚\n\
         æœ€å¾Œè«‹å°‡æ‰€æœ‰è‚¡ç¥¨ä¾ç…§è©•åˆ†æ’åºå‡ºä¾†ã€‚"
    }, {
        "role": "user",
        "content": str(data)
    }]
    reply_data = six.get_reply(msg)
    return reply_data

print(stock_sort(content))
```
## 8-3 AI å¹´å ±åˆ†ææ¨è–¦ç³»çµ±
```python
### 1ï¸âƒ£2ï¸âƒ£ å–å¾—å¤šæª”è‚¡ç¥¨çš„å¹´å ±æª”æ¡ˆ

# å»ºç«‹è‚¡ç¥¨æ¸…å–®
stock_list = ['2364', '2535', '3041', '5215', '2363',
              '1568', '2369', '2816', '9955', '2233']

# å–å¾—ä¸¦å„²å­˜å¹´å ±è³‡æ–™
for stock in stock_list:
  if not os.path.exists(f'/content/drive/MyDrive/StockGPT/PDF/113_{stock}.pdf'):
    try:
        seven.annual_report(stock,'113')
    except:
        time.sleep(10)
        while True:
            try:
                seven.annual_report(stock,'113')
                break
            except:
                time.sleep(10*2)

### 1ï¸âƒ£3ï¸âƒ£ å»ºç«‹å‘é‡è³‡æ–™åº«
"""
10 æª”è‚¡ç¥¨ç´„éœ€ 20 åˆ†é˜
"""

db_list=[]
for i in stock_list:
    if not os.path.exists(
        f'/content/drive/MyDrive/StockGPT/DB/113_{i}'):
        print('start',i)
        db_list.append(
            seven.pdf_loader(
                f'/content/drive/MyDrive/StockGPT/PDF/113_{i}.pdf',
                600, 60))

### 1ï¸âƒ£4ï¸âƒ£ è®€å–å‘é‡è³‡æ–™åº«

from langchain.embeddings import OpenAIEmbeddings
from langchain.vectorstores import FAISS

db_list=[]
for i in stock_list:
    db_list.append(
        FAISS.load_local(
          folder_path=f'/content/drive/MyDrive/StockGPT/DB/113_{i}',
          embeddings=OpenAIEmbeddings()
          ))

### 1ï¸âƒ£5ï¸âƒ£ å»ºç«‹å•é¡Œä¸²åˆ—é—œéµå­—

key_word = ['å…¬å¸çš„è²¡å‹™å¥å…¨åº¦ç‚ºä½•ï¼Ÿ',
            'ç‡Ÿé‹ç­–ç•¥å’Œå¸‚å ´å®šä½æ˜¯ä»€éº¼ï¼Ÿ',
            'é¢å°å“ªäº›ä¸»è¦é¢¨éšªå’ŒæŒ‘æˆ°ï¼Ÿ',
            'å…¬å¸åœ¨ç ”ç™¼å’Œå‰µæ–°æ–¹é¢æœ‰å“ªäº›æˆå°±å’Œè¨ˆåŠƒï¼Ÿ',
            'å…¬å¸æ²»ç†çµæ§‹å’Œç®¡ç†å±¤çš„çµ„æˆæ˜¯ï¼Ÿ']

### 1ï¸âƒ£6ï¸âƒ£ å–å¾—ç›¸é—œè³‡æ–™ & å»ºç«‹åˆ†ææ©Ÿå™¨äºº

# å»ºç«‹å¾å‘é‡è³‡æ–™åº«å–å¾—ç›¸é—œè³‡è¨Šå‡½å¼
def generate_data(db, key_word):
    results = []
    for word in key_word:
        results.append(seven.analyze_chain(db, word))
    return results

# å»ºç«‹å¹´å ±åˆ†ææ©Ÿå™¨äºº
def stock_report_summary(data):

    msg = [{
        "role": "system",
        "content": "ä½ ç¾åœ¨æ˜¯ä¸€ä½å°ˆæ¥­çš„å¹´å ±åˆ†æå¸«,\n\
                    ä½ æœƒé‡å°å¹´å ±å ±å‘Šå½™æ•´å‡ºä¸€ä»½å°ˆæ¥­çš„åˆ†æå ±å‘Šã€‚\n\
                    è«‹ä»¥è©³ç´°ã€åš´è¬¹åŠå°ˆæ¥­çš„è§’åº¦æ’°å¯«æ­¤å ±å‘Š,ä¸¦æåŠé‡è¦çš„æ•¸å­—\
                    ,reply in ç¹é«”ä¸­æ–‡"
    }, {
        "role": "user",
        "content": str(data)
    }]

    reply_data = six.get_reply(msg)

    return reply_data

### 1ï¸âƒ£7ï¸âƒ£ å¤šæª”è‚¡ç¥¨çš„å¹´å ±åˆ†æå ±å‘Š
"""
10 æª”è‚¡ç¥¨ç´„éœ€åŸ·è¡Œ 40 åˆ†é˜
"""

# å¹´å ±åˆ†ææª”æ¡ˆçš„å„²å­˜è·¯å¾‘
path = "/content/drive/MyDrive/StockGPT/AnnualReport/"
os.makedirs(path, exist_ok=True)


# å»ºç«‹å¤šæª”è‚¡ç¥¨çš„å¹´å ±åˆ†æå ±å‘Šä¸¦å„²å­˜
content = {}

for stock in tqdm(stock_list, total=len(stock_list)):
  file_path = f"{path}annual_{stock}_113.txt"

  if os.path.exists(file_path):
    print(f"{stock} æª”æ¡ˆå·²å­˜åœ¨")
  else:

      db = db_list[stock_list.index(stock)]
      report = stock_report_summary(generate_data(db, key_word))

      with open(file_path, "w", encoding="utf-8") as f:
        f.write(report)

  # å–å¾—è‚¡å
  name = six.stock_info.get_stock_name(stock, six.name_df)

  with open(file_path, "r", encoding="utf-8") as f:
      content[f"{name}({stock})"] = f.read()

### 1ï¸âƒ£8ï¸âƒ£ æ ¹æ“šåˆ†æçµæœæ¨è–¦å‡ºä¸€æª”è‚¡ç¥¨

print(stock_choice(content))

### 1ï¸âƒ£9ï¸âƒ£ å¹´å ±åˆ†æå ±å‘Šè©•åˆ†æ’åº

def stock_report_sort(data):
    # è¨­å®šæç¤ºæ¨¡æ¿
    msg = [{
        "role": "system",
        "content":
        "ä½ ç¾åœ¨æ˜¯ä¸€ä½å°ˆæ¥­çš„è‚¡ç¥¨åˆ†æå¸«, æœƒæ ¹æ“šå„è‚¡çš„å¹´å ±åˆ†æå ±å‘Šå»è©•æ–·\
         é©ä¸é©åˆæŠ•è³‡, ä¸¦çµ¦äºˆ0-100ä¹‹é–“çš„è©•åˆ†ã€‚\n\
         ä»¥ 50 åˆ†ç‚ºåŸºæº–, æœ‰ä»»ä½•æ­£é¢æ¶ˆæ¯å¯ä»¥åŠ åˆ†å¦‚:\n\
         è²¡å‹™å‘ˆç¾ç©©å®šå¢é•·çš„è¶¨å‹¢, å…·æœ‰ç«¶çˆ­å„ªå‹¢ï¼›\n\
         è‹¥æœ‰ä»»ä½•è² é¢æ¶ˆæ¯å¿…é ˆæ‰£åˆ†å¦‚:\n\
         è²¡å‹™å‘ˆç¾ä¸‹é™çš„è¶¨å‹¢, ä¸å…·æœ‰ç«¶çˆ­å„ªå‹¢ã€‚\n\
         æœ€å¾Œè«‹å°‡10æª”è‚¡ç¥¨ä¾ç…§è©•åˆ†æ’åºå‡ºä¾†ã€‚"
    }, {
        "role": "user",
        "content": str(data)
    }]
    reply_data = six.get_reply(msg)
    return reply_data

print(stock_report_sort(content))
```
